<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>

<!-- Core plugin JavaScript-->
<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ asset('vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

<!-- Core plugin JavaScript-->
<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>

<!-- Custom scripts for all pages-->
<script src="{{ asset('js/sb-admin-2.min.js') }}"></script>
<script src="{{ asset('js/mainJs/index.js') }}"></script>

<script src="{{ asset('js/mainJs/index.js') }}"></script>

<script>
$(document).ready(function() {

    const reset = () => {
        $(".btn_submit").attr("disabled", false);
        $(".btn_submit").css("background-color", "#EF0051");
        $(".btn_submit").hover(() => { $(".btn_submit").css("background-color", "#D31052") })
    };

    const disable = () => {
        $(".btn_submit").attr("disabled", true);
        $(".btn_submit").css("background-color", "gray");
    }

    let user = {};
    let channel = {};
    let downloadURLUser;

    let store = true;
    
    const token = localStorage.getItem("token");

    if(token !== ""){

        $.ajax({
            type: "POST", 
            url: "/profile/show", 
            data: JSON.stringify({
                "token": token,
            }),
            dataType: 'json',
            async: true,
            success: function(response) {

                if(response != undefined){
                    $('#myname').html(response.user[0].username);
                    $('#logo-setting').attr('src', response.user[0].avatar);

                    $('#username').attr('value', response.user[0].username);
                    $('#profil').attr('src', response.user[0].avatar);
                }
                console.log(response);
                user = response;
            },
            error: function (err) {
                
                console.log(err);
            }
        });
    }else{
        store = false;
        localStorage.removeItem('token');

         window.location.href = '/';

        console.log("Vous êtes deconnecté");
    }
   


    let firebaseConfig;


    $.ajax({
    method: "GET", 
    url: "/firebase", 
    async: true,
    success: function(data) {
    //console.log(data.apiKey+" "+data.authDomain+" "+data.databaseURL+" "+data.projectId+" "+data.storageBucket);
    
        firebaseConfig = {
            apiKey: data.apiKey,
            authDomain: data.authDomain,
            databaseURL: data.databaseURL,
            projectId: data.projectId,
            storageBucket: data.storageBucket
        };

        firebase.initializeApp(firebaseConfig);

     // changement input
        $('#cameraInput').on('change', function() {
             let userId = user.user[0].user_id;
            let selectedFile = event.target.files[0];

            let filename = $('#cameraInput').val().replace(/C:\\fakepath\\/i, '');
            let storageRef = firebase.storage().ref('/User/'+userId+ filename);

            let upload = storageRef.put(selectedFile);

            upload.on('state_changed', function(snapshot) {

            }, function(error) {
                console.log(error)
            }, function() {
                downloadURLUser = upload.snapshot.downloadURL;
                $('#profil').attr('src', downloadURLUser);
            });
        }); // camera



        $('#update_user').click(function(e) {
            e.preventDefault();
            disable();
            let downloadURL
            let usernameShow = $('#username').val();
            let idUser = user.user[0].user_id;
            let profil = $('#profil').attr('src');
            console.log(profil)
            if(downloadURLUser ===""){
                downloadURL = profil;
            }else {
                downloadURL = downloadURLUser;
            }

           let data = JSON.stringify({tokenUser:token , username: usernameShow, avatar: profil, userId:idUser});
            $.ajax({
                type: "POST", 
                url: "/profile/setting/show", 
                data: data,
                dataType: 'json',
                async: true,
                success: function(response) {
                    reset();
                    if(response != undefined){
                        /*$('#username').attr('value', response.user[0].username);
                        $('#profil').attr('src', response.user[0].avatar);*/
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    
                    console.log(err);
                }
            });

        }); // setting user



        //changer de avatar
        $('#cameraInputChannel').on('change', function() {
            let selectedFileChannel = event.target.files[0];

            let filenameChannel = $('#cameraInputChannel').val().replace(/C:\\fakepath\\/i, '');
            let storageRefChannel = firebase.storage().ref('/Channel/' + filenameChannel);

            let upload = storageRefChannel.put(selectedFileChannel);

            upload.on('state_changed', function(snapshot) {

            }, function(error) {
                console.log(error)
            }, function() {
                downloadURLChannel = upload.snapshot.downloadURL;
                $('#avatarChannel').attr('src', downloadURLChannel);
            });
        });

        //update channel
        $("#channelSave").click((e) => {
            e.preventDefault(); 
            disable();

            let name = $('#channels').val();
            let channelId = channel.channel._id;
            let avatar = $('#avatarChannel').attr('src');
            let downloadURLChannel = avatar;

            $.ajax({
                type: "POST", 
                url: "/myChannel", 
                data: JSON.stringify({
                    "token": token,
                    "downloadURLChannel": downloadURLChannel,
                    "name": name
                }),
                dataType: 'json',
                async: true,
                success: function(response) {
                    reset();
                    if(response != undefined){
                       /* $('#channels').html(response.user[0].username);
                        $('#avatarChannel').attr('src', response.user[0].avatar);*/
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    
                    console.log(err);
                }
            });
        });

    }

    }); // fin ajax firebase config

        //update password
        $("#savePassword").click((e) => {
            e.preventDefault(); 
            disable();

            let password = $('#password').val();

            $.ajax({
                type: "POST", 
                url: "/mypassword", 
                data: JSON.stringify({
                    "token": token,
                    "password": password,
                }),
                dataType: 'json',
                async: true,
                success: function(response) {

                    if(response != undefined){
                       /* $('#password').html(response.user[0].password);*/
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    
                    console.log(err);
                }
            });
        });
        
});
</script>