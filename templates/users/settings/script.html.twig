<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>

<!-- Core plugin JavaScript-->
<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ asset('vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

<!-- Core plugin JavaScript-->
<script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>

<!-- Custom scripts for all pages-->
<script src="{{ asset('js/sb-admin-2.min.js') }}"></script>
<script src="{{ asset('js/mainJs/index.js') }}"></script>

<script src="{{ asset('js/mainJs/index.js') }}"></script>

<script>
$(document).ready(function() {

    const reset = () => {
        $(".btn_submit").attr("disabled", false);
        $(".btn_submit").css("background-color", "#EF0051");
        $(".btn_submit").hover(() => { $(".btn_submit").css("background-color", "#D31052") })
    };

    const disable = () => {
        $(".btn_submit").attr("disabled", true);
        $(".btn_submit").css("background-color", "gray");
    }

    let users = {};
    let channel = {};
    let downloadURLUser;
    

    let store = true;
    
    const token      =  localStorage.getItem("token");
    let username     =  localStorage.getItem("username");
    let userAvatar   =  localStorage.getItem("avatar");
    let userPassword =  localStorage.getItem("password");
    let userId       =  localStorage.getItem("userId");
    let channelId    =  localStorage.getItem("channelId");
    let status       =  localStorage.getItem("status");

   
    $('#username').attr('value', username);
    $('#profil').attr('src', userAvatar);
    $('#password').attr('value', userPassword);
    


    let firebaseConfig;


    $.ajax({
    method: "GET", 
    url: "/firebase", 
    async: true,
    success: function(data) {
    //console.log(data.apiKey+" "+data.authDomain+" "+data.databaseURL+" "+data.projectId+" "+data.storageBucket);
    
        firebaseConfig = {
            apiKey: data.apiKey,
            authDomain: data.authDomain,
            databaseURL: data.databaseURL,
            projectId: data.projectId,
            storageBucket: data.storageBucket
        };

        firebase.initializeApp(firebaseConfig);

     // changement input
        $('#cameraInput').on('change', function() {
             
            let selectedFile = event.target.files[0];

            let filename = $('#cameraInput').val().replace(/C:\\fakepath\\/i, '');
            let storageRef = firebase.storage().ref('/User/'+userId+ filename);

            let upload = storageRef.put(selectedFile);

            upload.on('state_changed', function(snapshot) {

            }, function(error) {
                console.log(error)
            }, function() {
                downloadURLUser = upload.snapshot.downloadURL;
                $('#profil').attr('src', downloadURLUser);
            });
        }); // camera



        $('#update_user').click(function(e) {

            e.preventDefault();
            disable();
            let downloadURL
            let usernameShow = $('#username').val();
            let profil = $('#profil').attr('src');
            console.log(profil)
          
           let data = JSON.stringify({tokenUser:token , username: usernameShow, avatar: profil, idUser: userId});
            $.ajax({
                type: "POST", 
                url: "/profile/setting/show", 
                data: data,
                dataType: 'json',
                async: true,
                success: function(response) {
                    reset();
                    if(response != undefined){
                        //rep mise a jour 
                        $('#mycompte').html(response.message);
                        $('#mycompte').css("display","block");
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    reset();
                    console.log(err);
                }
            });

        }); // setting user



        if(token !== "")
        {
            channelId = channelId;
            let data = JSON.stringify({tokenChan: token, Idchannel: channelId});

            //channel
            $.ajax({
                type: "POST", 
                url: "/profile/channel/show", 
                data: data,
                dataType: 'json',
                async: true,
                success: function(response) {

                    if(response != undefined){

                        localStorage.setItem("channel_name", response.channel.channel_name);
                        localStorage.setItem("channel_avatar", response.channel.avatar);

                        let channelName = localStorage.getItem("channel_name");
                        let channelAvatar = localStorage.getItem("channel_avatar");

                        $('#channels').attr('value', channelName);
                        $('#avatarChannel').attr('src', channelAvatar);
                    }
                    console.log(response);
                    channel = response;
                },
                error: function (err) {
                    
                    console.log(err);
                }
            });
        }



        //changer de avatar
        $('#cameraInputChannel').on('change', function() {
            let selectedFileChannel = event.target.files[0];

            let filenameChannel = $('#cameraInputChannel').val().replace(/C:\\fakepath\\/i, '');
            let storageRefChannel = firebase.storage().ref('/Channel/'+channelId+filenameChannel);

            let upload = storageRefChannel.put(selectedFileChannel);

            upload.on('state_changed', function(snapshot) {

            }, function(error) {
                console.log(error)
            }, function() {
                downloadURLChannel = upload.snapshot.downloadURL;
                $('#avatarChannel').attr('src', downloadURLChannel);
            });
        });

        //update channel
        $("#channelSave").click((e) => {
            e.preventDefault(); 
            disable();

            let name = $('#channels').val();
            let idChannel = channel.channel._id;
            let avatar = $('#avatarChannel').attr('src');
            let downloadURLChannel = avatar;

            $.ajax({
                type: "POST", 
                url: "/profile/myChannel", 
                data: JSON.stringify({
                    "token": token,
                    "avatar": downloadURLChannel,
                    "name": name,
                    "channelId": idChannel,

                }),
                dataType: 'json',
                async: true,
                success: function(response) {
                    reset();
                    if(response != undefined){
                       
                       $('#mychannels').html(response.message);
                       $('#mychannels').css("display","block");
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    reset();
                    console.log(err);
                }
            });
        });

    }

    }); // fin ajax firebase config

        //update password
        $("#savePassword").click((e) => {
            e.preventDefault(); 
            disable();

            let password = $('#password').val();

            $.ajax({
                type: "POST", 
                url: "/profile/mypassword", 
                data: JSON.stringify({
                    "token": token,
                    "password": password,
                    "idUser": userId,
                }),
                dataType: 'json',
                async: true,
                success: function(response) {
                    reset();
                    if(response != undefined){
                        $('#mypassword').html(response.message); 
                        $('#mypassword').css("display","block");
                    }
                    console.log(response);
                
                },
                error: function (err) {
                    reset();
                    console.log(err);
                }
            });
        });// fin password
        
});
</script>